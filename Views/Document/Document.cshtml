<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

@model IEnumerable<BTLChatDemo.Models.Document.DocumentModel>

@* Thanh tìm kiếm ngang *@
<div class="row mb-3">
    <div class="col-12">
        <form method="get" asp-action="Index" class="d-flex">
            <input type="text" id="searchInput" name="searchTerm" value="@ViewBag.SearchTerm"
                   class="form-control me-2" placeholder="🔍 Tìm kiếm tài liệu..." />
            
        </form>
    </div>
</div>

<div class="row">
    <!-- Bộ lọc môn học (accordion bên trái) -->
    <div class="col-md-3">
        <div class="accordion" id="subjectFilter">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSubjects">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubjects">
                        📂 Lọc theo môn học
                    </button>
                </h2>
                <div id="collapseSubjects" class="accordion-collapse collapse" data-bs-parent="#subjectFilter">
                    <div class="accordion-body">
                        <form method="get" asp-action="Index">
                            @foreach (var subject in ViewBag.Subjects)
                            {
                                <div class="form-check">
                                    <input type="checkbox"
                                           name="subjectIds"
                                           value="@subject.Id"
                                           class="form-check-input subject-checkbox"
                                    @(((List<int>)ViewBag.SelectedSubjects).Contains(subject.Id) ? "checked" : "") />
                                    <label class="form-check-label">@subject.Name</label>
                                </div>
                            }
                            
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Danh sách tài liệu -->
    <div class="col-md-9">
        @if (Model == null || !Model.Any())
        {
            <p class="text-muted">Không có tài liệu nào.</p>
        }
        else
        {
            <div class="row" id="documentList">
                @foreach (var doc in Model)
                {
                    <div class="col-md-4 mb-4 doc-card" data-subjectid="@doc.SubjectId">
                        <div class="card shadow-sm h-100">
                            <!-- Ảnh: giữ tỉ lệ gốc, không cắt -->
                            <a href="@doc.FileUrl" target="_blank">
                                <div style="height:200px; background-color:#f8f9fa; display:flex; align-items:center; justify-content:center;">
                                    <img src="@doc.ThumbnailUrl"
                                         alt="@doc.Title"
                                         style="max-height:100%; max-width:100%; object-fit:contain;" />
                                </div>
                            </a>

                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <!-- Tiêu đề căn giữa -->
                                    <h6 class="card-title mb-0 text-center flex-grow-1">
                                        <a href="@doc.FileUrl" target="_blank" class="text-decoration-none d-block">
                                            @doc.Title
                                        </a>
                                    </h6>

                                    <!-- Icon tải xuống bên phải -->
                                    <a href="@Url.Action("Download", "StudentDocument", new { id = doc.Id })"
                                       class="btn btn-sm btn-outline-success ms-2"
                                       title="Tải xuống">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

        }
    </div>
</div>

<script>
    const searchInput = document.getElementById("searchInput");
    const checkboxes = document.querySelectorAll(".subject-checkbox");

    function filterDocuments() {
        const keyword = searchInput.value.toLowerCase();
        const checkedSubjects = Array.from(checkboxes)
                                    .filter(cb => cb.checked)
                                    .map(cb => cb.value);

        document.querySelectorAll(".doc-card").forEach(card => {
            const title = card.querySelector(".card-title").innerText.toLowerCase();
            const subjectId = card.getAttribute("data-subjectid");

            const matchKeyword = title.includes(keyword);
            const matchSubject = checkedSubjects.length === 0 || checkedSubjects.includes(subjectId);

            card.style.display = (matchKeyword && matchSubject) ? "" : "none";
        });
    }

    // Gắn sự kiện cho input và checkbox
    searchInput.addEventListener("keyup", filterDocuments);
    checkboxes.forEach(cb => cb.addEventListener("change", filterDocuments));
</script>