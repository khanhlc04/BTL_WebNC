@model IEnumerable<BTL_WebNC.Models.Teacher.TeacherModel>
@using System.Security.Claims

@{
    ViewData["Title"] = "Danh sách giảng viên";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userEmail = User.FindFirst(ClaimTypes.Email)?.Value ?? string.Empty;
    var isStudent = userEmail.EndsWith("@students.hou.edu.vn");
    var subjects = ViewBag.Subjects as IEnumerable<BTL_WebNC.Models.Subject.SubjectModel> ??
    Enumerable.Empty<BTL_WebNC.Models.Subject.SubjectModel>();
}

<style>
    .teacher-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    .teacher-card {
        background: #fff;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        flex: 1 1 calc(25% - 16px);
        min-width: 220px;
        position: relative;
        text-decoration: none;
        color: inherit;
    }

    .teacher-thumb {
        text-align: center;
        margin-bottom: 8px;
    }

    .teacher-thumb img {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        display: inline-block;
    }

    .teacher-card h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
    }

    .teacher-card p {
        margin: 0;
        color: #555;
        font-size: 14px;
    }

    .chat-btn {
        position: absolute;
        right: 8px;
        top: 8px;
    }

    @@media (max-width:768px) {
        .teacher-card {
            flex: 1 1 100%;
        }
    }
</style>

<form asp-action="Index" method="get">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Danh sách giảng viên</h4>

        <div class="input-group w-50">
            <input type="text" name="searchString" value="@ViewData["CurrentFilter"]"
                class="form-control d-inline-block w-auto" placeholder="Tìm kiếm tài liệu..." />

            <button id="clearSearch" class="btn btn-outline-secondary" title="Xóa" type="submit">
                Tìm
            </button>
        </div>

        <div class="filter-subjects" style="min-width:220px;">
       <label for="subjectSelect" class="form-label visually-hidden">Chọn môn học</label>
       <select id="subjectSelect" name="subjectId" multiple class="form-select form-select-sm">
           <option disabled>-- Chọn môn học --</option>
           @foreach (var subject in subjects)
           {
               <option value="@subject.Id">@subject.Name</option>
           }
       </select>
       <div id="subjectBadges" class="mt-2"></div>
   </div>
    </div>
</form>

<div class="teacher-grid">
    @if (Model != null)
    {
        foreach (var item in Model)
        {
            <div class="teacher-card">
                @if (isStudent)
                {
                    <a class="btn btn-sm btn-success chat-btn"
                        href="@Url.Action("Index", "Chat", new { recipientId = item.AccountId })">Chat</a>
                }

                <div class="teacher-thumb">
                    @if (!string.IsNullOrEmpty(item.ThumbnailPath))
                    {
                        <img src="/@item.ThumbnailPath" alt="@item.FullName" />
                    }
                    else
                    {
                        <div
                            style="width:96px;height:96px;border-radius:50%;background:#e9ecef;display:inline-flex;align-items:center;justify-content:center;color:#6c757d;font-weight:600;">
                            @((item.FullName ?? "").Split(' ').LastOrDefault() ?? "T")</div>
                    }
                </div>

                <h4><a href="@Url.Action("Details", "Teacher", new { id = item.Id })">@item.FullName</a></h4>
                <p>@(item.Email ?? "-")</p>
                <p style="margin-top:8px; color:#888; font-size:13px;">Môn:
                    @if (item.TeacherSubjects != null && item.TeacherSubjects.Any())
                    {
                        @string.Join(", ", item.TeacherSubjects.Select(ts => ts.Subject?.Name ?? "N/A"))
                    }
                    else
                    {
                        <span>Chưa đăng ký môn học</span>
                    }
                </p>
            </div>
        }
    }
    else
    {
        <div>Không có giảng viên phù hợp.</div>
    }
</div>